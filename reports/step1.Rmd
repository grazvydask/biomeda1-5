```{r libs, echo = FALSE, include = FALSE}
library(annmatrix)
library(ggplot2)
library(reshape2)
library(basetheme)
library(MASS)
```


```{r data load, echo = FALSE, include = FALSE}
met_annmat = readRDS("../output/step1_annmat.RDS")
```

# Outlier removal {.tabset}

## IAC

### Correlation matrix

```{r correlation matrix, echo = FALSE, include= TRUE}
cor_mat <- cor(met_annmat)
ggplot(melt(cor_mat)) +
	geom_tile(aes(x = Var1, y = Var2, fill = value)) +
	theme(axis.text.x=element_blank(), axis.text.y=element_blank()) +
	ylab("") + xlab("")
```

### Mean correlations {.tabset}

Row means of the correlation matrix

```{r mean cor, results = "asis", echo = FALSE, include = TRUE}
cor_means <- colMeans(cor_mat)

cat("### Initial")
cat(' \n\n')
basetheme(basetheme_dark())
hist(cor_means, col = "red")

outlier_no = 100
sd_cutoff = -4
it_no = 0
while(outlier_no > 0){
	it_no = it_no + 1
    cor_mat <- cor(met_annmat)
    cor_means <- scale(colMeans(cor_mat))
    stopifnot(sum(rownames(cor_means) != colnames(met_annmat)) == 0)
    met_annmat <- met_annmat[,cor_means > sd_cutoff]
    outlier_no <- sum(cor_means < sd_cutoff)
	cat(' \n\n')
	cat(paste0("### Iteration No. ", it_no))
	cat(' \n\n')
	hist(cor_means, col = "red", main = "standard units of IACs", xlab = "")
	abline(v = sd_cutoff, col = "blue")
}

```

## Mean distance from neighbours {.tabset}

### Initial

```{r mean dists, echo = FALSE, include = TRUE}
sample_dists <- as.matrix(dist(t(met_annmat)))
mean_dists <- scale(colMeans(sample_dists))

hist(mean_dists, breaks=15, col = "green")
abline(v = sd_cutoff, col = "red")

met_annmat <- met_annmat[, abs(mean_dists) < abs(sd_cutoff)]
```

### 1st round

After removal of outliers

```{r mean dists, echo = FALSE, include = TRUE}

sample_dists <- as.matrix(dist(t(met_annmat)))
mean_dists <- scale(colMeans(sample_dists))

hist(mean_dists, breaks=15, col = "green")
abline(v = sd_cutoff, col = "red")
```

Number of samples left: `r ncol(met_annmat)`

# Quality control

## Distribution of methylation in different regions

As expected, CpG seas and shelves have high methylation values while
islands and shores have low methylation.

```{r region densities, echo = FALSE, include = TRUE}
cpg_means <- rowMeans(met_annmat)
names(cpg_means) <- met_annmat@Relation_to_Island
cpg_shore <- cpg_means[names(cpg_means) %in% c("N_Shore", "S_Shore")]
cpg_shelf <- cpg_means[names(cpg_means) %in% c("N_Shelf", "S_Shelf")]
cpg_island <- cpg_means[names(cpg_means) == "Island"]
cpg_sea <- cpg_means[names(cpg_means) == "OpenSea"]

basetheme(basetheme_brutal())

plot(density(cpg_sea), col = "blue", main = NA, cex= 2)
lines(density(cpg_island), col = "palegoldenrod", cex = 2)
lines(density(cpg_shore), col = "palegreen", cex = 2)
lines(density(cpg_shelf), col = "purple4", cex = 2)

legend(x = 0.3, y = 3,
	legend = c("sea", "island", "shore", "shelf"),
	col = c("blue", "palegoldenrod", "palegreen", "purple4"),
	lty = 1, cex = 2
)
```

## Multidimensional scaling {.tabset}

Samples divide based on sex nicely when using both MDS methods.

### PCA

```{r pca, echo = FALSE, include = TRUE}
met_pca <- prcomp(t(met_annmat))$x
plot(met_pca[,1:2], col = as.factor(met_annmat$sex), main = "PCA, coloured by sex")
```

### Sammon map

```{r sammon, echo = FALSE, include = TRUE}
met_sample_dist = dist(t(met_annmat))
met_sammon <- sammon(met_sample_dist)
plot(met_sammon$points, col = as.factor(met_annmat$sex), main = "Sammon map, coloured by sex")
```

